<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stok Master v14.0 (Tam Gizlilik)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; touch-action: manipulation; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .critical-stock { border: 2px solid #ef4444 !important; animation: pulseRed 2s infinite; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* MODERN FORM */
        .input-group { margin-bottom: 0.8rem; }
        .input-label { display: block; font-size: 0.7rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 0.3rem; letter-spacing: 0.05em; }
        .modern-input { width: 100%; background-color: #1e293b; border: 1px solid #334155; color: white; padding: 0.7rem 0.9rem; border-radius: 0.6rem; font-size: 0.95rem; font-weight: 500; outline: none; transition: all 0.2s; }
        .modern-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .modern-select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
    </style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

</head>
<body>

    <div id="login-screen" class="fixed inset-0 bg-gray-900 z-[9999] flex flex-col items-center justify-center p-6">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700 w-full max-w-sm text-center">
            <div class="mb-8">
                <div class="w-20 h-20 bg-blue-600/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/50">
                    <i class="fa-solid fa-user-shield text-4xl text-blue-400"></i>
                </div>
                <h2 class="text-2xl font-bold text-white">Personel GiriÅŸi</h2>
            </div>
            
            <div class="mb-4 text-left">
                <label class="input-label text-center">ADINIZ / RUMUZUNUZ</label>
                <input type="text" id="staff-name-input" class="modern-input text-center text-lg font-bold h-12 border-blue-500/50 focus:border-blue-400" placeholder="KullanÄ±cÄ± AdÄ±" autocomplete="off">
            </div>

            <div class="mb-6 text-left">
                <label class="input-label text-center text-yellow-500">YÃ–NETÄ°CÄ° ÅžÄ°FRESÄ° (OPSÄ°YONEL)</label>
                <input type="tel" id="login-pin" maxlength="6" class="modern-input text-center text-lg font-bold h-12 border-gray-600 focus:border-yellow-500 tracking-widest" placeholder="******">
                <p class="text-[10px] text-gray-500 text-center mt-1">*Sadece genel ciroyu gÃ¶rmek iÃ§in.</p>
            </div>

            <button onclick="checkLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl text-lg transition-colors shadow-lg shadow-blue-900/40">SÄ°STEMÄ° AÃ‡</button>
        </div>
    </div>

    <div id="create-modal" class="hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-gray-800 border border-gray-600 w-full max-w-md rounded-2xl p-6 shadow-2xl modal-enter relative overflow-y-auto max-h-[95vh]">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                <h3 class="text-lg font-bold text-white">ÃœrÃ¼n TanÄ±mla</h3>
                <button onclick="closeCreateModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div class="space-y-1">
                <div class="input-group">
                    <label class="input-label">ÃœrÃ¼n AdÄ±</label>
                    <input type="text" id="new-name" class="modern-input" placeholder="Ã–rn: Saray HalÄ±">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="input-group">
                        <label class="input-label">Tek ÃœrÃ¼n Ã–lÃ§Ã¼sÃ¼</label>
                        <input type="number" id="new-size" class="modern-input" placeholder="Ã–rn: 6">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Ã–lÃ§Ã¼ Birimi</label>
                        <select id="new-unit" class="modern-input modern-select">
                            <option value="MÂ²">MÂ² (Metrekare)</option>
                            <option value="M">METRE</option>
                            <option value="CM">CM</option>
                            <option value="MM">MM</option>
                            <option value="KG">KG</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="input-group">
                        <label class="input-label">Birim Fiyat (TL)</label>
                        <input type="number" id="new-price" class="modern-input" placeholder="0.00">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Stok Adedi</label>
                        <input type="number" id="new-stock" class="modern-input text-yellow-400 font-bold" placeholder="0">
                    </div>
                </div>
                <div class="mt-2 bg-gray-900/60 p-3 rounded-xl border border-gray-700">
                    <label class="input-label text-blue-400 flex items-center gap-2 mb-2"><i class="fa-solid fa-tags"></i> Ã–zel Etiket</label>
                    <div class="grid grid-cols-5 gap-2">
                        <div class="col-span-2"><input type="text" id="new-extra-label" class="modern-input text-xs" placeholder="Etiket"></div>
                        <div class="col-span-3"><input type="text" id="new-extra-value" class="modern-input text-xs" placeholder="DeÄŸer"></div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-6">
                <button onclick="closeCreateModal()" class="bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-xl font-bold">Ä°PTAL</button>
                <button onclick="saveProductData()" class="bg-green-600 hover:bg-green-500 text-white py-3 rounded-xl font-bold shadow-lg">KAYDET</button>
            </div>
        </div>
    </div>

    <div id="app-content" class="flex flex-col h-full hidden">
        
        <header class="bg-gray-800 p-2 shadow-md border-b border-gray-700 z-20 shrink-0">
            <div class="flex justify-between items-center mb-1">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-user-circle text-blue-400"></i>
                    <span id="staff-name-disp" class="font-bold text-white text-sm">...</span>
                </div>
                <div class="flex gap-2">
                     <button onclick="showListPage()" class="bg-gray-700 px-3 py-1 rounded text-[10px] font-bold text-white border border-gray-600">LÄ°STE</button>
                     <button onclick="logout()" class="bg-red-900/50 px-2 py-1 rounded text-[10px] text-red-300 border border-red-800">Ã‡IK</button>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-2 bg-black/40 p-2 rounded-lg border border-gray-700">
                <div class="text-center border-r border-gray-700">
                    <div class="text-[9px] text-gray-400 uppercase font-bold">BENÄ°M CÄ°ROM</div>
                    <div id="my-ciro" class="text-green-400 font-bold text-sm">0â‚º</div>
                </div>
                <div class="text-center" id="shop-ciro-box">
                    <div class="text-[9px] text-gray-400 uppercase font-bold" id="shop-ciro-label">DÃœKKAN TOPLAM</div>
                    <div id="shop-ciro" class="text-yellow-500 font-bold text-sm">0â‚º</div>
                </div>
            </div>
        </header>

        <div id="status-box" class="absolute top-24 left-1/2 transform -translate-x-1/2 bg-green-600 px-4 py-2 rounded-full text-sm font-bold text-white z-50 transition-opacity duration-500 opacity-0 shadow-lg border border-green-400">Ä°ÅŸlem BaÅŸarÄ±lÄ±</div>

        <div id="confirm-modal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-gray-800 border border-gray-600 w-full max-w-sm rounded-2xl p-6 shadow-2xl modal-enter text-center">
                <h3 class="text-xl font-bold text-white mb-4">SatÄ±ÅŸ OnayÄ±</h3>
                <p class="text-gray-300 text-lg mb-6"><span id="confirm-amount" class="font-bold text-white text-2xl">0</span> Adet Ã‡Ä±kÄ±ÅŸ YapÄ±lacak.</p>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="closeModal()" class="bg-gray-600 text-white py-3 rounded-xl font-bold">Ä°PTAL</button>
                    <button onclick="confirmTransaction()" class="bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg">SATIÅžI ONAYLA</button>
                </div>
            </div>
        </div>

        <div id="scan-page" class="flex-1 flex flex-col items-center justify-center p-4 overflow-y-auto">
            <div class="relative w-full max-w-sm aspect-square bg-black rounded-2xl overflow-hidden shadow-2xl border-2 border-yellow-600 mb-6 shrink-0 flex items-center justify-center">
                <div id="reader" class="w-full h-full object-cover"></div>
                <div id="camera-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 z-10">
                    <i class="fa-solid fa-camera-slash text-6xl text-gray-600 mb-4"></i>
                    <p class="text-gray-400 text-sm font-bold">Kamera KapalÄ±</p>
                </div>
                <div class="absolute inset-0 border-4 border-yellow-500/30 m-8 rounded-xl pointer-events-none z-20"></div>
            </div>

            <button id="toggle-cam-btn" onclick="toggleCamera()" class="w-full max-w-sm bg-blue-600 text-white py-5 rounded-xl font-bold text-xl shadow-lg active:scale-95 flex items-center justify-center gap-3 transition-colors">
                <i class="fa-solid fa-camera"></i> <span>KAMERAYI AÃ‡</span>
            </button>

            <div class="w-full max-w-sm mt-6 border-t border-gray-700 pt-4">
                <button onclick="sendDailyReport()" class="w-full bg-green-700/40 text-green-400 border border-green-600 py-2 rounded-lg font-bold text-sm mb-4 flex items-center justify-center gap-2">
                    <i class="fa-brands fa-whatsapp"></i> GÃœN SONU RAPORU GÃ–NDER
                </button>
                <div class="text-[10px] text-gray-500 uppercase font-bold mb-2">CanlÄ± SatÄ±ÅŸ AkÄ±ÅŸÄ±</div>
                <div id="last-transactions" class="space-y-1 text-xs text-gray-400">Loading...</div>
            </div>
        </div>

        <div id="product-page" class="hidden flex-1 flex flex-col bg-gray-900 p-4 overflow-y-auto pb-32">
            <div class="flex justify-between items-center mb-2">
                <button onclick="goHome()" class="text-gray-400 flex items-center gap-2 text-sm w-fit p-2 hover:text-white"><i class="fa-solid fa-arrow-left"></i> Kapat</button>
                <div class="flex gap-2">
                    <button onclick="openCreateModal(true)" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-1.5 rounded-full text-xs font-bold border border-gray-600"><i class="fa-solid fa-pen"></i> DÃœZENLE</button>
                    <button onclick="shareProductWhatsapp()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded-full text-xs font-bold"><i class="fa-brands fa-whatsapp fa-lg"></i></button>
                </div>
            </div>
            <div class="bg-gray-800 rounded-2xl p-5 shadow-xl border-l-4 border-yellow-500 relative mb-4 shrink-0">
                <div class="flex justify-between items-start mb-2">
                    <div id="p-id-badge" class="text-[10px] text-gray-500 font-mono bg-black/50 px-2 py-1 rounded max-w-[200px] truncate">ID: ...</div>
                </div>
                <h1 id="p-name" class="text-2xl font-bold text-white mb-4 leading-tight break-words">...</h1>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-900/50 p-3 rounded-xl border border-gray-700">
                        <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Birim Fiyat</div>
                        <div id="p-price-disp" class="text-2xl font-bold text-green-400">0â‚º</div>
                    </div>
                    <div class="bg-gray-900/50 p-3 rounded-xl border border-gray-700 text-right">
                        <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Stok (Adet)</div>
                        <div id="p-stock" class="text-4xl font-bold text-yellow-500">0</div>
                    </div>
                </div>
                <div id="p-extra-info" class="mt-3 bg-blue-900/20 border border-blue-900/30 p-3 rounded-lg flex justify-between items-center hidden">
                    <span id="p-extra-label" class="text-xs text-blue-300 font-bold uppercase tracking-wider">...</span>
                    <span id="p-extra-value" class="text-sm text-white font-mono bg-blue-900/40 px-2 py-0.5 rounded">...</span>
                </div>
                <div class="mt-3 text-right">
                    <span class="text-[10px] text-gray-400 uppercase mr-2 font-bold">ÃœRÃœN Ã–LÃ‡ÃœSÃœ:</span>
                    <span id="p-size-disp" class="text-lg font-bold text-blue-400 uppercase">0 M2</span>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-600 shadow-lg mb-4">
                <div class="text-xs text-gray-400 font-bold uppercase mb-3 flex justify-between items-center border-b border-gray-700 pb-2">
                    <span><i class="fa-solid fa-scissors"></i> ParÃ§a Kes / AyÄ±r</span>
                </div>
                <div class="flex gap-0 w-full">
                    <input type="number" step="any" id="cut-input" placeholder="Kesilen" class="w-full bg-gray-900 text-white py-3 px-4 rounded-l-lg border border-gray-600 border-r-0 focus:border-gray-500 outline-none font-bold text-lg">
                    <button onclick="processCut()" class="bg-gray-700 text-white px-6 rounded-r-lg font-bold border border-gray-600 hover:bg-gray-600 active:bg-gray-500 whitespace-nowrap transition-colors">KES</button>
                </div>
                <p class="text-[10px] text-gray-500 mt-2 text-right text-blue-300">*1 Stok DÃ¼ÅŸer, Kalan Depoya Eklenir.</p>
            </div>
            <div id="offcut-container" class="bg-gray-800 p-4 rounded-xl border border-gray-600 shadow-lg hidden mb-4">
                <h3 class="text-xs text-gray-400 font-bold uppercase mb-3 border-b border-gray-600 pb-2 flex justify-between items-center">
                    <span><i class="fa-solid fa-layer-group text-blue-400"></i> ARTANLAR</span>
                </h3>
                <div id="offcut-list" class="space-y-2"></div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg">
                <label class="text-gray-400 text-xs uppercase font-bold ml-1 mb-2 block">HÄ±zlÄ± SatÄ±ÅŸ (Adet):</label>
                <div class="relative mb-4">
                    <input type="number" id="manual-qty" placeholder="SatÄ±ÅŸ MiktarÄ±" class="w-full bg-gray-900 text-white text-center text-3xl font-bold py-4 rounded-lg border-2 border-red-900/50 focus:border-red-600 outline-none appearance-none transition-colors" inputmode="numeric">
                </div>
                <button onclick="requestTransaction()" class="w-full bg-red-600 hover:bg-red-700 py-4 rounded-xl font-bold text-xl shadow-lg shadow-red-900/40 border-b-4 border-red-800 flex items-center justify-center gap-3 transition-transform active:scale-[0.98]">
                    <i class="fa-solid fa-basket-shopping"></i> SATIÅž YAP
                </button>
            </div>
            <div class="h-20"></div>
        </div>

        <div id="list-page" class="hidden flex-1 flex flex-col bg-gray-900 p-4 overflow-hidden">
            <div class="flex items-center gap-2 mb-4">
                <button onclick="goHome()" class="bg-gray-800 p-2.5 rounded-lg text-gray-400 border border-gray-700"><i class="fa-solid fa-arrow-left"></i></button>
                <input type="text" oninput="renderList(this.value)" placeholder="ÃœrÃ¼n Ara..." class="w-full bg-gray-900 text-white px-4 py-2.5 rounded-lg border border-gray-700 outline-none focus:border-yellow-500 transition-colors">
            </div>
            <div id="list-container" class="flex-1 overflow-y-auto space-y-3 pb-20"></div>
        </div>
    </div>

    <script>
        const ADMIN_PIN = "545454"; // ProgramÄ±n kendi ÅŸifresi, aynen duruyor

// --- HAYALET KÄ°LÄ°T SÄ°STEMÄ° ---
const sifreliKasa = "U2FsdGVkX1+jbdHHaQn0ShWGuHDpiCvHb46R/CaCfRiI/3ht55j9G8svrxMJuPkLxvSrtGcGbKv0VVJ+GUjdUg=="; 
const gizliPin = "1453"; 

const bytes = CryptoJS.AES.decrypt(sifreliKasa, gizliPin);
const cozulmusToken = bytes.toString(CryptoJS.enc.Utf8);

const CONFIG = { 
    USER: "fthlabz", 
    REPO: "stok-takip", 
    FILE: "stok.json", 
    TOKEN: cozulmusToken // Kriptodan Ã§Ã¶zÃ¼len ÅŸifre buraya oturdu
};

        let db = { products: {}, dailyStats: { date: "", ciro: 0, log: [] } };
        let currentId = null;
        let scanner = null;
        let isCameraRunning = false;
        let fileSha = null;
        let isProcessing = false;
        let currentStaff = ""; 
        let isAdmin = false;

        window.onload = async () => {
            const savedStaff = sessionStorage.getItem("currentStaff");
            const savedAdmin = sessionStorage.getItem("isAdmin") === "true";
            
            if(sessionStorage.getItem("auth") === "true" && savedStaff) {
                currentStaff = savedStaff;
                isAdmin = savedAdmin;
                unlockApp();
            } else {
                document.getElementById('staff-name-input').focus();
            }
        };

        function checkLogin() {
            const staff = document.getElementById('staff-name-input').value.trim();
            const pin = document.getElementById('login-pin').value.trim();
            if(!staff) return alert("LÃ¼tfen isminizi girin!");
            
            if(pin === ADMIN_PIN) {
                isAdmin = true;
                showStatus("YÃ¶netici GiriÅŸi");
            } else {
                isAdmin = false;
                if(pin !== "") alert("Åžifre HatalÄ±! Personel olarak giriÅŸ yapÄ±lÄ±yor.");
            }

            currentStaff = staff;
            sessionStorage.setItem("currentStaff", staff);
            sessionStorage.setItem("isAdmin", isAdmin);
            unlockApp();
        }

        async function unlockApp() {
            sessionStorage.setItem("auth", "true");
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('staff-name-disp').innerText = currentStaff + (isAdmin ? " (YÃ¶netici)" : "");
            await syncFromCloud();
        }

        function logout() {
            sessionStorage.clear();
            location.reload();
        }

        async function syncFromCloud() {
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${CONFIG.FILE}`, { headers: { 'Authorization': `token ${CONFIG.TOKEN}` }, cache: "no-store" });
                if(!res.ok) throw new Error();
                const data = await res.json();
                fileSha = data.sha;
                db = JSON.parse(decodeURIComponent(escape(window.atob(data.content))));
                if(!db.dailyStats) db.dailyStats = { date: "", ciro: 0, log: [] };
                const today = new Date().toLocaleDateString('tr-TR');
                if (db.dailyStats.date !== today) db.dailyStats = { date: today, ciro: 0, log: [] };
                showStatus("HazÄ±r ðŸŸ¢", false);
                updateDashboardStats();
            } catch (e) { showStatus("BaÄŸlantÄ± Yok ðŸ”´", false); }
        }

        async function saveToCloud() {
            showStatus("Kaydediliyor...", true);
            const content = window.btoa(unescape(encodeURIComponent(JSON.stringify(db, null, 2))));
            try {
                await fetch(`https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${CONFIG.FILE}`, { method: 'PUT', headers: { 'Authorization': `token ${CONFIG.TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: "Update", content, sha: fileSha }) });
                const res = await fetch(`https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${CONFIG.FILE}`, { headers: { 'Authorization': `token ${CONFIG.TOKEN}` }, cache: "no-store" });
                const data = await res.json();
                fileSha = data.sha;
                showStatus("Kaydedildi âœ…", false);
            } catch(e) { showStatus("Hata! âŒ", false); }
        }

        function updateDashboardStats() {
            if(db.dailyStats) {
                // 1. DÃ¼kkan Toplam (YÃ¶netici GÃ¶rÃ¼r)
                if(isAdmin) {
                    document.getElementById('shop-ciro').innerText = formatMoney(db.dailyStats.ciro);
                    document.getElementById('shop-ciro-label').innerText = "DÃœKKAN TOPLAM";
                    document.getElementById('shop-ciro-box').classList.remove('opacity-50');
                } else {
                    document.getElementById('shop-ciro').innerText = "ðŸ”’ GÄ°ZLÄ°";
                    document.getElementById('shop-ciro-label').innerText = "YETKÄ° YOK";
                    document.getElementById('shop-ciro-box').classList.add('opacity-50');
                }

                // 2. KiÅŸisel Ciro
                let myTotal = 0;
                db.dailyStats.log.forEach(item => { if(item.staff === currentStaff) myTotal += item.total; });
                document.getElementById('my-ciro').innerText = formatMoney(myTotal);

                // 3. Log Listesi (FÄ°LTRELÄ° - GÃœVENLÄ°K KÄ°LÄ°DÄ°)
                const logContainer = document.getElementById('last-transactions');
                
                // --- Ä°ÅžTE SÄ°HÄ°RLÄ° DOKUNUÅž BURADA ---
                // EÄŸer yÃ¶netici deÄŸilse, sadece kendi satÄ±ÅŸlarÄ±nÄ± gÃ¶rÃ¼r.
                // YÃ¶neticiyse hepsini gÃ¶rÃ¼r.
                let visibleLogs = [];
                if(isAdmin) {
                    visibleLogs = db.dailyStats.log;
                } else {
                    visibleLogs = db.dailyStats.log.filter(l => l.staff === currentStaff);
                }

                if(visibleLogs.length === 0) {
                    logContainer.innerHTML = '<div class="text-center italic text-gray-600">HenÃ¼z satÄ±ÅŸÄ±nÄ±z yok...</div>';
                } else {
                    logContainer.innerHTML = visibleLogs.slice(0, 10).map(l => {
                        const isMe = l.staff === currentStaff;
                        const colorClass = isMe ? "text-green-400" : "text-gray-500";
                        return `<div class="flex justify-between border-b border-gray-700 pb-1 text-[10px]">
                            <span class="text-white">${l.name}</span>
                            <div class="text-right">
                                <span class="font-bold ${colorClass}">${l.staff}</span> 
                                <span class="text-red-400">(${l.qty} Ad)</span>
                            </div>
                        </div>`;
                    }).join('');
                }
            }
        }

        function toggleCamera() {
            const btn = document.getElementById('toggle-cam-btn');
            const overlay = document.getElementById('camera-overlay');
            if(isCameraRunning) {
                if(scanner) scanner.stop().then(() => { scanner.clear(); });
                isCameraRunning = false;
                btn.innerHTML = '<i class="fa-solid fa-camera"></i> <span>KAMERAYI AÃ‡</span>';
                btn.className = "w-full max-w-sm bg-blue-600 text-white py-5 rounded-xl font-bold text-xl shadow-lg active:scale-95 flex items-center justify-center gap-3 transition-colors";
                overlay.classList.remove('hidden');
            } else {
                scanner = new Html5Qrcode("reader");
                scanner.start({ facingMode: "environment" }, { fps: 25, qrbox: 250 }, findProduct);
                isCameraRunning = true;
                btn.innerHTML = '<i class="fa-solid fa-stop"></i> <span>KAMERAYI KAPAT</span>';
                btn.className = "w-full max-w-sm bg-red-600 text-white py-5 rounded-xl font-bold text-xl shadow-lg active:scale-95 flex items-center justify-center gap-3 transition-colors";
                overlay.classList.add('hidden');
            }
        }

        function findProduct(code) {
            if (code.includes("id=")) code = code.split("id=")[1];
            if(isProcessing) return; 
            isProcessing = true;
            if(isCameraRunning) toggleCamera();
            currentId = code;
            if (!db.products[code]) openCreateModal(false);
            else showProductPage();
            setTimeout(() => { isProcessing = false; }, 1000); 
        }

        function openCreateModal(isEdit) {
            const modal = document.getElementById('create-modal');
            const p = isEdit ? db.products[currentId] : null;
            document.getElementById('new-name').value = p ? p.name : "";
            document.getElementById('new-price').value = p ? p.price : "";
            document.getElementById('new-stock').value = p ? p.stock : "";
            document.getElementById('new-size').value = p ? p.size : ""; 
            document.getElementById('new-unit').value = p ? p.unit : "MÂ²";
            document.getElementById('new-extra-label').value = p && p.extraLabel ? p.extraLabel : "";
            document.getElementById('new-extra-value').value = p && p.extraValue ? p.extraValue : "";
            modal.classList.remove('hidden');
        }

        function closeCreateModal() {
            document.getElementById('create-modal').classList.add('hidden');
            if(!db.products[currentId]) goHome(); 
        }

        async function saveProductData() {
            const name = document.getElementById('new-name').value;
            const price = parseFloat(document.getElementById('new-price').value) || 0;
            const stock = parseFloat(document.getElementById('new-stock').value) || 0;
            const size = parseFloat(document.getElementById('new-size').value) || 0;
            const unit = document.getElementById('new-unit').value;
            const exLabel = document.getElementById('new-extra-label').value;
            const exValue = document.getElementById('new-extra-value').value;
            if(!name) return alert("ÃœrÃ¼n adÄ± giriniz.");
            if(!db.products[currentId]) db.products[currentId] = { offcuts: [] };
            const p = db.products[currentId];
            p.name = name; p.price = price; p.stock = stock; p.size = size; p.unit = unit;
            p.extraLabel = exLabel; p.extraValue = exValue;
            closeCreateModal();
            showStatus(db.products[currentId].offcuts.length > 0 ? "GÃ¼ncellendi" : "Kaydedildi");
            await saveToCloud();
            showProductPage();
        }

        function showProductPage() {
            document.querySelectorAll('[id$="-page"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('product-page').classList.remove('hidden');
            const p = db.products[currentId];
            let displayId = currentId;
            if(displayId.length > 20) { if(displayId.includes("id=")) displayId = displayId.split("id=")[1]; else if(displayId.includes("/")) displayId = displayId.split("/").pop(); }
            document.getElementById('p-id-badge').innerText = "ID: " + displayId;
            document.getElementById('p-name').innerText = p.name;
            document.getElementById('p-price-disp').innerText = formatMoney(p.price || 0);
            document.getElementById('p-stock').innerText = p.stock;
            const unit = p.unit || 'MÂ²';
            document.getElementById('p-size-disp').innerText = (p.size||0) + " " + unit;
            const extraBox = document.getElementById('p-extra-info');
            if(p.extraLabel && p.extraValue) {
                extraBox.classList.remove('hidden');
                document.getElementById('p-extra-label').innerText = p.extraLabel;
                document.getElementById('p-extra-value').innerText = p.extraValue;
            } else { extraBox.classList.add('hidden'); }
            const container = document.getElementById('offcut-container');
            const list = document.getElementById('offcut-list');
            list.innerHTML = "";
            if (p.offcuts && p.offcuts.length > 0) {
                container.classList.remove('hidden');
                p.offcuts.forEach((amt, idx) => {
                    const row = document.createElement('div');
                    row.className = "flex justify-between items-center bg-black/40 p-3 rounded border border-gray-600";
                    row.innerHTML = `<div class="flex items-center gap-2"><i class="fa-solid fa-puzzle-piece text-gray-500"></i><span class="text-blue-300 font-bold text-lg">${amt} ${unit}</span></div><button onclick="sellOffcut(${idx})" class="bg-red-900/80 text-red-200 text-xs px-3 py-2 rounded font-bold border border-red-700 hover:bg-red-800">SÄ°L</button>`;
                    list.appendChild(row);
                });
            } else { container.classList.add('hidden'); }
            setTimeout(() => { document.getElementById('manual-qty').focus(); }, 300);
        }

        async function processCut() {
            const p = db.products[currentId];
            const cutVal = parseFloat(document.getElementById('cut-input').value);
            const totalSize = parseFloat(p.size) || 0;
            const unit = p.unit || "Birim";
            if (!cutVal) return alert("Kesilecek miktarÄ± girin!");
            if(p.stock <= 0) return alert("Stok yok!");
            if(cutVal >= totalSize) return alert("ÃœrÃ¼n boyutundan fazla kesemezsiniz!");
            const remaining = parseFloat((totalSize - cutVal).toFixed(2));
            if(confirm(`âœ‚ï¸ KESÄ°M ONAYI\n\nStoktan 1 ADET dÃ¼ÅŸÃ¼lecek.\nKesilen: ${cutVal} ${unit}\nDepoya Artan: ${remaining} ${unit}`)) {
                p.stock--;
                if(!p.offcuts) p.offcuts = [];
                p.offcuts.push(remaining); 
                showStatus("ParÃ§a AyrÄ±ldÄ±");
                document.getElementById('cut-input').value = "";
                await saveToCloud(); 
                showProductPage();
            }
        }

        function requestTransaction() {
            const val = parseFloat(document.getElementById('manual-qty').value);
            if (!val) return alert("Miktar gir!");
            document.getElementById('confirm-amount').innerText = val;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        async function confirmTransaction() {
            document.getElementById('confirm-modal').classList.add('hidden');
            const val = parseFloat(document.getElementById('manual-qty').value);
            const p = db.products[currentId];
            p.stock -= val;
            const totalSale = p.price * val;
            db.dailyStats.ciro += totalSale;
            db.dailyStats.log.unshift({ name: p.name, qty: val, total: totalSale, staff: currentStaff });
            updateDashboardStats();
            document.getElementById('manual-qty').value = "";
            showProductPage(); 
            await saveToCloud();
        }

        function sendDailyReport() {
            if(!db.dailyStats || db.dailyStats.log.length === 0) return alert("BugÃ¼n hareket yok.");
            let msg = `ðŸ“… *GÃœN SONU RAPORU* (${db.dailyStats.date})\n`;
            if(isAdmin) msg += `ðŸ’° *TOPLAM CÄ°RO:* ${formatMoney(db.dailyStats.ciro)}\n`;
            else msg += `ðŸ’° *BENÄ°M CÄ°ROM:* ${document.getElementById('my-ciro').innerText}\n`;
            msg += `------------------\n`;
            
            let staffTotals = {};
            db.dailyStats.log.forEach(l => {
                if(!staffTotals[l.staff]) staffTotals[l.staff] = 0;
                staffTotals[l.staff] += l.total;
            });
            
            if(isAdmin) {
                for (let [person, total] of Object.entries(staffTotals)) {
                    msg += `ðŸ‘¤ *${person}:* ${formatMoney(total)}\n`;
                }
            }

            msg += `------------------\n*SatÄ±ÅŸ DetayÄ±:*\n`;
            // Personel sadece kendi satÄ±ÅŸlarÄ±nÄ± rapora dÃ¶ker, Patron hepsini.
            const reportLogs = isAdmin ? db.dailyStats.log : db.dailyStats.log.filter(l => l.staff === currentStaff);
            
            reportLogs.slice(0, 15).forEach(l => {
                msg += `ðŸ”¹ ${l.staff}: ${l.name} (${l.qty} Ad) - ${formatMoney(l.total)}\n`;
            });

            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function shareProductWhatsapp() {
            const p = db.products[currentId];
            let msg = `ðŸ“¦ *ÃœrÃ¼n Bilgisi*\n*ÃœrÃ¼n:* ${p.name}\n*Fiyat:* ${formatMoney(p.price)}\n*Stok:* ${p.stock}\n*Ã–lÃ§Ã¼:* ${p.size} ${p.unit}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        async function sellOffcut(index) {
            if(confirm("ParÃ§a silinsin mi?")) { db.products[currentId].offcuts.splice(index, 1); showStatus("Silindi ðŸ—‘ï¸"); await saveToCloud(); showProductPage(); }
        }

        function closeModal() { document.getElementById('confirm-modal').classList.add('hidden'); }
        function showStatus(msg, load) { const el = document.getElementById('status-box'); el.innerText = msg; el.style.opacity = "1"; if(!load) setTimeout(() => el.style.opacity = "0", 2000); }
        function formatMoney(val) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(val).replace('â‚º', '') + 'â‚º'; }
        
        function goHome() { 
            document.querySelectorAll('[id$="-page"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('scan-page').classList.remove('hidden');
            currentId = null; if(isCameraRunning) toggleCamera();
            syncFromCloud();
        }

        function showListPage() {
            if(isCameraRunning) toggleCamera();
            document.querySelectorAll('[id$="-page"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('list-page').classList.remove('hidden');
            renderList("");
        }
        
        function renderList(filter) {
            const c = document.getElementById('list-container'); c.innerHTML = "";
            Object.keys(db.products).forEach(k => {
                const p = db.products[k];
                if (p.name.toLowerCase().includes(filter.toLowerCase())) {
                    const d = document.createElement('div');
                    const isCritical = p.stock < 3; 
                    d.className = `bg-gray-800 p-4 rounded-xl border ${isCritical ? 'critical-stock' : 'border-gray-700'} flex justify-between items-center`;
                    d.innerHTML = `<div onclick="findProduct('${k}')" class="flex-1 cursor-pointer"><div class='font-bold text-white'>${p.name}</div><div class='text-xs text-gray-500'>${p.size||0} ${p.unit||''}</div></div><div class='text-right mr-2'><div class='${isCritical ? 'text-red-500' : 'text-yellow-500'} font-bold'>${p.stock} <span class="text-[10px] text-gray-400">ADT</span></div><div class='text-green-400 text-xs'>${formatMoney(p.price)}</div></div>`;
                    c.appendChild(d);
                }
            });
        }
    </script>
</body>
</html>
